#
# Configure authorization for the StashCache origin server.
#
# **********************************************************************
# * WARNING: DO NOT EDIT THIS FILE.  IT WILL BE OVERWRITTEN ON UPGRADE *
# **********************************************************************
#
# This file is part of the StashCache Daemon
# https://opensciencegrid.org/docs/data/stashcache/overview/

# Proxy cert for reporting and communicating with cache servers
setenv X509_USER_PROXY = /run/xcache-auth/x509_proxy

# Enable the authorization module, even if we have an unauthenticated instance.
ofs.authorize 1
# Log both successes and failures in authorization.
acc.audit deny grant


if named stash-origin-auth

   xrootd.seclib /usr/lib64/libXrdSec.so

   # Set libXrdLcmaps to be used only to invoke Globus and libvoms
   # to verify the proxy; authorizations will be handled internally.
   sec.protocol /usr/lib64 gsi \
        -certdir:/etc/grid-security/certificates \
        -cert:/etc/grid-security/xrd/xrdcert.pem \
        -key:/etc/grid-security/xrd/xrdkey.pem \
        -crl:1 \
        -authzfun:libXrdLcmaps.so \
        -authzfunparms:--lcmapscfg=/etc/xrootd/lcmaps.cfg,--no-authz \
        -gmapopt:0 \
        -authzto:3600

   sec.protbind * gsi

fi

# xrootd config does not do nested "unqualified" ifs
if defined ?StashOriginAuthfile && named stash-origin-auth
   acc.authdb $StashOriginAuthfile
# nor negations ("!")
else if named stash-origin-auth
   acc.authdb /run/stash-origin-auth/Authfile
fi



if named stash-origin

   xrd.allow host *
   sec.protocol  host
   sec.protbind  * none

fi

# xrootd config does not do nested "unqualified" ifs
if defined ?StashOriginPublicAuthfile && named stash-origin
   acc.authdb $StashOriginPublicAuthfile
# nor negations ("!")
else if named stash-origin
   acc.authdb /run/stash-origin/Authfile
fi

